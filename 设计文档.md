# 设计文档
## 技术栈
* 数据状态管理：mobx
* 数据请求：fetch
* 多语言支持：i18n-js
* eslint: gts + eslint-plugin-i18ntest(自封装校验硬编码eslint插件)


## fetch api封装
* 超时处理：15s请求超时后，抛出错误
* 统一的错误处理：网络请求报错时统一处理错误，未登录跳转至登录，其他情况toast提示文案
```js
Promise.race([fetchPromise, fetchTimeout(10000)]).catch(err => {
  if (err === 'invalid_token') {
    // 未登录时跳转登录
    RootNavigation.navigate('Login', {});
  } else {
    // 提示错误
    ToastTip.show(err);
  }
}
```
* 对所有接口请求封装，便于维护
```js
// 获取活动列表
export const getEventsApi = async (params = {}) => {
  // removeStorage('userdata');
  return request('/events', 'GET', params);
};

// 获取活动详情
export const getEventDetailApi = async (eventId: number) => {
  return request(`/events/${eventId}`, 'GET');
};
```

## store设计 - mobx
##### store中存储的数据：
* 用户信息数据（头像、用户名、token）userData
* 活动列表数据 events
* 频道信息 channelData
* 筛选栏已选中信息 selectChannel selectTime startTime endTime
* 当前语言 lang

##### 由于store中存入的数据不多，未使用模块化，降低复杂度


## 登陆状态储存和 token 失效验证的设计
##### 登陆状态的保存
* 储存形式：登陆状态主要利用了 mobx + AsyncStorage 的形式进行储存，在成功登陆后会将token分别存入 store 和 AsyncStorage 中
* 在封装的 fetch 接口头部中增加 'X-BLACKCAT-TOKEN'，先取 store 中的数据，若store中没有，则从storage中获取，同时再次同步到store中

```js
  let userData = stores.userData;
  // 先从store中获取，若store中没有，则到本地存储中查找
  if (userData.token) {
    return userData;
  } else {
    userData = await getStorage('userdata');
    if (userData.token) {
      stores.setUserData(userData);
      return userData;
    }
  }
```
##### 登陆失效的跳转
fetch中统一处理，返回登录态失效后跳转到登录页


## 无限滚动设计
##### FlatList
* 选用react-native官方无限滚动组件，性能较好，使用简单
##### 设置优化选项
* renderItem组件使用react.memo封装
* 设置keyExtractor为id


## UI组件设计
##### 公共组件 - 基础组件以及不同页面中会复用的组件
* Header titlebar
* MyInput 输入框
* Toast 顶部滑动toast组件
* ToastTip 错误提示组件，基于库react-native-root-siblings实现，可直接在js中调用
* SwitchLang 切换语言组件
* ListItem 活动列表项
* Tabbar tab

目录结构如下：
<br><img src="/assets/page/components.jpg" width="200"/><br>

##### 业务组件 - 清晰逻辑，易于维护
目录结构如下：
<br><img src="/assets/page/detail.jpg" width="200"/><br>


##### 复用样式 - 抽离公用颜色变量和公用class
* colors 输出公用颜色变量
* class 输出公用样式
<br><img src="/assets/page/styles.jpg" width="200"/><br>

## 多语言实现
##### i18n-js expo官方推荐库
* 输出公用i18nT方法，通过store切换语言
```js
const i18nT = (name: string) => {
  return i18n.t(name, {locale: stores.lang});
};
```
```js
// 使用
<Text style={styles.loginText1}>{i18nT('slogan')}</Text>
```
* 输出公用切换语言组件

## eslint配置
* gts配置
* 实现检查硬编码eslint插件 eslint-plugin-i18ntest(已发包到npm中: https://www.npmjs.com/package/eslint-plugin-i18ntest)

效果如下：检测到标签中的硬编码以及js中的硬编码时会出现warning
<br><img src="/assets/page/i18n-1.jpg" width="400"/><br>
<img src="/assets/page/i18n-2.jpg" width="400"/><br>

## 交互优化
* 搜索导航展示与收起加入滑动动画效果
<br><img src="/assets/page/search-nav.png" width="200"/><br>
* 详情页 tab 滑动时粘附于顶部，页面滚动时计算元素高度和滑动高度使得高亮tab跟随滑动位置改变状态
* 详情页选中tab后滑动到对应区域
<br><img src="/assets/page/participant.png" width="200"/><br>
* 添加评论后滑动到页面底部评论区部分，同时弹出滑动toast
<br><img src="/assets/page/comment.png" width="200"/><br>
